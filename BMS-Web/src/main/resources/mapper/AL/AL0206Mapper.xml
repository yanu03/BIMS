<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.tracom.brt.domain.AL0206.AL0206Mapper">

<select id="AL0206G0R0" resultType="Map">
	SELECT A.REP_ROUT_ID,
			A.ROUT_ID,
			A.DAY_DIV,
			A.WAY_DIV,
			A.OPER_SN,
			A.ALLOC_NO,
			A.COR_ID,
			A.REST_TM,
			A.ROUT_ST_TM,
			A.ROUT_ED_TM,
			A.UPD_DTM,
			A.UPD_ID,
			B.REP_ROUT_NM,
			B.WAY_ASC_NM,
			B.WAY_DESC_NM,
			C.ROUT_NM,
			C.ROAT_TM,
			D.COR_NM,
			D.COR_COLOR
			,F.VHC_ID
			,F.VHC_NO
			,H.DRV_ID
			,H.DRV_NM
			,(SELECT DRV_ID FROM BMS_DRV_MST S WHERE G.SEC_DRV_ID = S.DRV_ID) AS SEC_DRV_ID
			,(SELECT DRV_NM FROM BMS_DRV_MST S WHERE G.SEC_DRV_ID = S.DRV_ID) AS SEC_DRV_NM
		FROM BRT_OPER_ALLOC_PL_ROUT_INFO A
			INNER JOIN BMS_REP_ROUT_MST B
				ON A.REP_ROUT_ID = B.REP_ROUT_ID
			LEFT OUTER JOIN BMS_ROUT_MST C
				ON A.ROUT_ID = C.ROUT_ID AND C.DEL_YN != 'Y'
			LEFT OUTER JOIN BRT_COR_MST D
				ON A.COR_ID = D.COR_ID 
			LEFT JOIN BRT_ALLOC_PL_MST E
				ON A.REP_ROUT_ID = E.REP_ROUT_ID
				AND A.DAY_DIV = E.DAY_DIV
				AND A.ALLOC_NO = E.ALLOC_NO
				AND A.WAY_DIV = E.WAY_DIV
			LEFT JOIN BMS_VHC_MST F
				ON E.VHC_ID = F.VHC_ID
			LEFT JOIN BRT_DRV_ALLOC_INFO G
				ON A.REP_ROUT_ID = G.REP_ROUT_ID
				AND A.DAY_DIV = G.DAY_DIV
				AND A.ALLOC_NO = G.ALLOC_NO 
			LEFT JOIN BMS_DRV_MST H
				ON G.DRV_ID = H.DRV_ID
		WHERE A.REP_ROUT_ID = #{REP_ROUT_ID}
			AND A.DAY_DIV = #{DAY_DIV}
			<if test="@kr.tracom.util.CommonUtil@notEmpty(CONTENT1)">
			AND (H.DRV_NM LIKE CONCAT('%',#{CONTENT1},'%') OR F.VHC_NO LIKE CONCAT('%',#{CONTENT1},'%'))
			</if>
			ORDER BY REP_ROUT_ID, DAY_DIV, ALLOC_NO, OPER_SN
</select>

<select id="AL0206G0CNT" resultType="Map">
		SELECT COUNT(*) CNT
		FROM BRT_OPER_ALLOC_PL_ROUT_INFO
		WHERE REP_ROUT_ID = #{REP_ROUT_ID} AND DAY_DIV = #{DAY_DIV}
		GROUP BY REP_ROUT_ID, DAY_DIV, ALLOC_NO 
		ORDER BY REP_ROUT_ID, DAY_DIV, ALLOC_NO

	</select>

<!-- <select id="AL0206G0R0" resultType="Map">
	SELECT
		A.REP_ROUT_ID
		,A.DAY_DIV
		,A.WAY_DIV
		,B.REP_ROUT_NM
		,MAX(CASE A.WAY_DIV WHEN 'WD001' THEN C.STTN_NM END) AS ASC_ST_STTN_NM
		,MAX(CASE A.WAY_DIV WHEN 'WD001' THEN D.STTN_NM END) AS ASC_ED_STTN_NM
		,MAX(CASE A.WAY_DIV WHEN 'WD002' THEN C.STTN_NM END) AS DESC_ST_STTN_NM
		,MAX(CASE A.WAY_DIV WHEN 'WD002' THEN D.STTN_NM END) AS DESC_ED_STTN_NM
	FROM
		BRT_OPER_PL_MST A
		LEFT JOIN BMS_REP_ROUT_MST B
		ON A.REP_ROUT_ID = B.REP_ROUT_ID
		LEFT JOIN BMS_STTN_MST C
		ON A.ST_STTN_ID = C.STTN_ID
		LEFT JOIN BMS_STTN_MST D
		ON A.ED_STTN_ID = D.STTN_ID
	<where>
		<if test="CONTENT1 == 'all'">
			A.REP_ROUT_ID LIKE CONCAT('%',#{CONTENT3},'%')
		</if>
		<if test="CONTENT1 != 'all'">
			AND A.REP_ROUT_ID = #{CONTENT1}
		</if>
		<if test="CONTENT2 != ''">
			AND A.DAY_DIV = #{CONTENT2}
		</if>
	</where>
	GROUP BY 
		B.REP_ROUT_ID, A.DAY_DIV
	ORDER BY
		B.REP_ROUT_NM, A.DAY_DIV, A.WAY_DIV DESC
</select>

<select id="AL0206SHI1" resultType="Map">
		SELECT			DAY_DIV
		FROM			BRT_OPER_PL_MST
		<where>
			<if test="CONTENT1 != null">
				REP_ROUT_ID = #{CONTENT1}	
			</if>
		</where>
	</select>

<select id="AL0206G1R0" resultType="Map">
	SELECT A.REP_ROUT_ID
	       ,A.DAY_DIV
	       ,A.WAY_DIV
	       ,A.ALLOC_NO
	       ,B.VHC_ID
	       ,D.VHC_NO
	       ,E.COMP_NM
	       ,F.DRV_ID
			,F.SEC_DRV_ID
			,F.THR_DRV_ID
			,(SELECT DRV_NM FROM BMS_DRV_MST WHERE DRV_ID = F.DRV_ID) DRV_NM
			,(SELECT DRV_NM FROM BMS_DRV_MST WHERE DRV_ID = F.SEC_DRV_ID) SEC_DRV_NM
			,(SELECT DRV_NM FROM BMS_DRV_MST WHERE DRV_ID = F.THR_DRV_ID) THR_DRV_NM
			,F.SEC_TRAN_TM
			,F.THR_TRAN_TM
	FROM 
		BRT_OPER_ALLOC_PL_ROUT_INFO A
		LEFT JOIN BRT_ALLOC_PL_MST B
		ON A.REP_ROUT_ID = B.REP_ROUT_ID AND A.DAY_DIV = B.DAY_DIV AND A.ALLOC_NO = B.ALLOC_NO
		LEFT JOIN BRT_REP_ROUT_VHC_CMPSTN C
		ON B.VHC_ID = C.VHC_ID
		LEFT JOIN BMS_VHC_MST D
		ON B.VHC_ID = D.VHC_ID
		LEFT JOIN BMS_TRANSCOMP_MST E
		ON D.COMP_ID = E.COMP_ID
		LEFT JOIN BRT_DRV_ALLOC_INFO F
		ON A.REP_ROUT_ID = F.REP_ROUT_ID AND A.ALLOC_NO = F.ALLOC_NO 
		LEFT JOIN BRT_REP_ROUT_DRV_CMPSTN G
		ON F.DRV_ID = G.DRV_ID
	WHERE
		A.REP_ROUT_ID = #{REP_ROUT_ID}
	AND 
		A.DAY_DIV = #{DAY_DIV}
	
	GROUP BY
		A.ALLOC_NO
	ORDER BY
		A.ALLOC_NO
</select>

<insert id="AL0206G1U0" parameterType="Map">
	INSERT INTO BRT_ALLOC_PL_MST(
		REP_ROUT_ID
		,DAY_DIV
		,ALLOC_NO
		,WAY_DIV
		,VHC_ID
		,UPD_DTM
		,UPD_ID
	)VALUES(
		#{REP_ROUT_ID}
		,#{DAY_DIV}
		,#{ALLOC_NO}
		,#{WAY_DIV}
		,#{VHC_ID}
		,#{UPD_DTM}
		,#{SSN_USER_ID}
	)ON DUPLICATE KEY UPDATE
		VHC_ID = VALUES(VHC_ID)
		,UPD_DTM = VALUES(UPD_DTM)
		,UPD_ID	 = VALUES(UPD_ID)
</insert>

<insert id="AL0206G1U1" parameterType="Map">
	INSERT INTO BRT_DRV_ALLOC_INFO(
		REP_ROUT_ID
		,ALLOC_NO
		,DAY_DIV
		,DRV_ID
		,SEC_DRV_ID
		,THR_DRV_ID
		,SEC_TRAN_TM
		,THR_TRAN_TM
	)VALUES(
		#{REP_ROUT_ID}
		,#{ALLOC_NO}
		,#{DAY_DIV}
		,#{DRV_ID}
		,#{SEC_DRV_ID}
		,#{THR_DRV_ID}
		,#{SEC_TRAN_TM}
		,#{THR_TRAN_TM}
	)ON DUPLICATE KEY UPDATE
		DRV_ID = VALUES(DRV_ID)
		,SEC_DRV_ID = VALUES(SEC_DRV_ID)
		,THR_DRV_ID = VALUES(THR_DRV_ID)
		,SEC_TRAN_TM = VALUES(SEC_TRAN_TM)
		,THR_TRAN_TM = VALUES(THR_TRAN_TM)
</insert>

 <update id="AL0206G1U0" parameterType="Map">
	UPDATE
		BRT_ALLOC_PL_MST
	SET
		VHC_ID = #{VHC_ID}
		,UPD_DTM = #{UPD_DTM}
		,UPD_ID	 = #{SSN_USER_ID}
	WHERE
		REP_ROUT_ID = #{REP_ROUT_ID}
	AND
		DAY_DIV = #{DAY_DIV}
	AND
		ALLOC_NO = #{ALLOC_NO};
</update>

<update id="AL0206G1U1" parameterType="Map">
	UPDATE
		BRT_DRV_ALLOC_INFO
	SET
		DRV_ID = #{DRV_ID}
		,SEC_DRV_ID = #{SEC_DRV_ID}
		,THR_DRV_ID = #{THR_DRV_ID}
		,SEC_TRAN_TM = #{SEC_TRAN_TM}
		,THR_TRAN_TM = #{THR_TRAN_TM}
	WHERE
		REP_ROUT_ID = #{REP_ROUT_ID}
	AND
		ALLOC_NO = #{ALLOC_NO};
</update>

<insert id="AL0206G1I0" parameterType="Map">
	INSERT INTO BRT_DAY_ALLOC_PL_INFO(
		OPER_DT
		,REP_ROUT_ID
		,WAY_DIV
		,ALLOC_NO
		,VHC_ID
		,UPD_DTM
	)VALUES(
		#{OPER_DT}
		,#{REP_ROUT_ID}
		,#{WAY_DIV}
		,#{ALLOC_NO}
		,#{VHC_ID}
		,#{UPD_DTM}
	)ON DUPLICATE KEY UPDATE
		VHC_ID = VALUES(VHC_ID)
		,UPD_DTM = VALUES(UPD_DTM)
</insert>

<insert id="AL0206G1I1" parameterType="Map">
	INSERT INTO BRT_DAY_DRV_ALLOC_INFO(
		OPER_DT
		,REP_ROUT_ID
		,ALLOC_NO
		,DAY_DIV
		,DRV_ID
		,SEC_DRV_ID
		,THR_DRV_ID
		,SEC_TRAN_TM
		,THR_TRAN_TM
	)VALUES(
		#{OPER_DT}
		,#{REP_ROUT_ID}
		,#{ALLOC_NO}
		,#{DAY_DIV}
		,#{DRV_ID}
		,#{SEC_DRV_ID}
		,#{THR_DRV_ID}
		,#{SEC_TRAN_TM}
		,#{THR_TRAN_TM}
	)ON DUPLICATE KEY UPDATE
		DRV_ID = VALUES(DRV_ID)
		,SEC_DRV_ID = VALUES(SEC_DRV_ID)
		,THR_DRV_ID = VALUES(THR_DRV_ID)
		,SEC_TRAN_TM = VALUES(SEC_TRAN_TM)
		,THR_TRAN_TM = VALUES(THR_TRAN_TM)
</insert>

<update id="AL0206G2U0" parameterType="Map">
	UPDATE
		BRT_DAY_ALLOC_PL_INFO
	SET
		VHC_ID = #{VHC_ID}
		,UPD_DTM = #{UPD_DTM}
	WHERE
		REP_ROUT_ID = #{REP_ROUT_ID}
	AND
		ALLOC_NO = #{ALLOC_NO}
	AND
		OPER_DT = #{OPER_DT}
</update>

<update id="AL0206G2U1" parameterType="Map">
	UPDATE
		BRT_DAY_DRV_ALLOC_INFO
	SET
		DRV_ID = #{DRV_ID}
		,SEC_DRV_ID = #{SEC_DRV_ID}
		,THR_DRV_ID = #{THR_DRV_ID}
		,SEC_TRAN_TM = #{SEC_TRAN_TM}
		,THR_TRAN_TM = #{THR_TRAN_TM}
	WHERE
		REP_ROUT_ID = #{REP_ROUT_ID}
	AND
		ALLOC_NO = #{ALLOC_NO}
	AND
		DAY_DIV = #{DAY_DIV}
	AND
		OPER_DT = #{OPER_DT}
</update>

<select id="AL0206G2R0" resultType="Map">
	SELECT A.REP_ROUT_ID
	       ,A.DAY_DIV
	       ,A.ALLOC_NO
	       ,B.VHC_ID
	       ,DATE_FORMAT(B.OPER_DT, '%Y-%m-%d') OPER_DT
	       ,D.VHC_NO
	       ,E.COMP_NM
	       ,H.DRV_ID
			,H.SEC_DRV_ID
			,H.THR_DRV_ID
			,(SELECT DRV_NM FROM BMS_DRV_MST WHERE DRV_ID = H.DRV_ID) DRV_NM
			,(SELECT DRV_NM FROM BMS_DRV_MST WHERE DRV_ID = H.SEC_DRV_ID) SEC_DRV_NM
			,(SELECT DRV_NM FROM BMS_DRV_MST WHERE DRV_ID = H.THR_DRV_ID) THR_DRV_NM
			,H.SEC_TRAN_TM
			,H.THR_TRAN_TM
	FROM 
		BRT_OPER_ALLOC_PL_ROUT_INFO A
		LEFT JOIN BRT_DAY_ALLOC_PL_INFO B
		ON A.REP_ROUT_ID = B.REP_ROUT_ID AND A.ALLOC_NO = B.ALLOC_NO
		LEFT JOIN BMS_VHC_MST D
		ON B.VHC_ID = D.VHC_ID
		LEFT JOIN BMS_TRANSCOMP_MST E
		ON D.COMP_ID = E.COMP_ID
		LEFT JOIN BRT_DRV_ALLOC_INFO F
		ON A.REP_ROUT_ID = F.REP_ROUT_ID AND A.ALLOC_NO = F.ALLOC_NO
		LEFT JOIN BRT_DAY_DRV_ALLOC_INFO H
		ON A.REP_ROUT_ID = H.REP_ROUT_ID AND A.ALLOC_NO = H.ALLOC_NO  
	WHERE
		A.REP_ROUT_ID = #{REP_ROUT_ID}
	AND 
		A.DAY_DIV = #{DAY_DIV}
	AND
		B.OPER_DT = #{OPER_DT} AND H.OPER_DT = #{OPER_DT}

	GROUP BY
		A.ALLOC_NO
	ORDER BY
		A.ALLOC_NO
</select> -->

</mapper>
